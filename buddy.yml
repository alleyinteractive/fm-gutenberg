- pipeline: "Test all PRs"
  trigger_mode: "ON_EVERY_PUSH"
  ref_name: "refs/pull/*"
  ref_type: "WILDCARD"
  priority: "NORMAL"
  fail_on_prepare_env_warning: true
  trigger_condition: "ALWAYS"
  actions:
  - action: "phpunit latest"
    type: "BUILD"
    working_directory: "/buddy/wp-starter-plugin"
    docker_image_name: "alleyops/ci-resources"
    docker_image_tag: "7.4-fpm-wp"
    execute_commands:
    - "composer -q global require \"phpunit/phpunit=6.1.*\""
    - ""
    - "# Install tests"
    - "bash bin/install-wp-tests.sh wordpress_test root root mysql ${WP_VERSION}"
    - ""
    - "# Wire up object-cache and inform WordPress config about the server location"
    - "echo \"extension=memcache.so\" >> /usr/local/etc/php/conf.d/buddy.ini"
    - "echo 'global $memcached_servers;' >> ${WP_TESTS_DIR}/wp-tests-config.php # Notably requires setting it globally"
    - "echo '$memcached_servers = array(\"memcached:11211\");' >> ${WP_TESTS_DIR}/wp-tests-config.php # See https://github.com/Automattic/wp-memcached/blob/master/readme.txt"
    - ""
    - "# Rsync the plugin to ${WP_CORE_DIR} for testing"
    - "rsync -a \\"
    - "\t--exclude=.git \\"
    - "\t--exclude=.npm \\"
    - "\t--exclude=.composer \\"
    - "\t--exclude=node_modules \\"
    - "\t. \"${WP_CORE_DIR}/wp-content/plugins/${PLUGIN_SLUG}\""
    - ""
    - "# Hop into plugin's directory."
    - "cd ${WP_CORE_DIR}/wp-content/plugins/${PLUGIN_SLUG}/ "
    - ""
    - "echo \"Running phpunit single/multisite without object cache...\""
    - "phpunit"
    - "WP_MULTISITE=1 phpunit"
    - ""
    - "echo \"Running phpunit single/multisite with object cache...\""
    - "curl -s https://raw.githubusercontent.com/Automattic/wp-memcached/master/object-cache.php > \"${WP_CORE_DIR}/wp-content/object-cache.php\""
    - "phpunit"
    - "WP_MULTISITE=1 phpunit"
    services:
    - type: "MYSQL"
      version: "5.7"
      connection:
        host: "mysql"
        port: 3306
        user: "root"
        password: "root"
    - type: "MEMCACHED"
      version: "1.5.6"
      connection:
        host: "memcached"
        port: 11211
    volume_mappings:
    - "/:/buddy/wp-starter-plugin"
    trigger_condition: "ALWAYS"
    shell: "BASH"
    run_next_parallel: true
    variables:
    - key: "WP_VERSION"
      value: "latest"
  - action: "phpunit trunk"
    type: "BUILD"
    working_directory: "/buddy/wp-starter-plugin"
    docker_image_name: "alleyops/ci-resources"
    docker_image_tag: "7.4-fpm-wp"
    execute_commands:
    - "composer -q global require \"phpunit/phpunit=6.1.*\""
    - ""
    - "# Install tests"
    - "bash bin/install-wp-tests.sh wordpress_test root root mysql ${WP_VERSION}"
    - ""
    - "# Wire up object-cache and inform WordPress config about the server location"
    - "echo \"extension=memcache.so\" >> /usr/local/etc/php/conf.d/buddy.ini"
    - "echo 'global $memcached_servers;' >> ${WP_TESTS_DIR}/wp-tests-config.php # Notably requires setting it globally"
    - "echo '$memcached_servers = array(\"memcached:11211\");' >> ${WP_TESTS_DIR}/wp-tests-config.php # See https://github.com/Automattic/wp-memcached/blob/master/readme.txt"
    - ""
    - "# Rsync the plugin to ${WP_CORE_DIR} for testing"
    - "rsync -a \\"
    - "\t--exclude=.git \\"
    - "\t--exclude=.npm \\"
    - "\t--exclude=.composer \\"
    - "\t--exclude=node_modules \\"
    - "\t. \"${WP_CORE_DIR}/wp-content/plugins/${PLUGIN_SLUG}\""
    - ""
    - "# Hop into plugin's directory."
    - "cd ${WP_CORE_DIR}/wp-content/plugins/${PLUGIN_SLUG}/ "
    - ""
    - "echo \"Running phpunit single/multisite without object cache...\""
    - "phpunit"
    - "WP_MULTISITE=1 phpunit"
    - ""
    - "echo \"Running phpunit single/multisite with object cache...\""
    - "curl -s https://raw.githubusercontent.com/Automattic/wp-memcached/master/object-cache.php > \"${WP_CORE_DIR}/wp-content/object-cache.php\""
    - "phpunit"
    - "WP_MULTISITE=1 phpunit"
    services:
    - type: "MYSQL"
      version: "5.7"
      connection:
        host: "mysql"
        port: 3306
        user: "root"
        password: "root"
    - type: "MEMCACHED"
      version: "1.4.29"
      connection:
        host: "memcached"
        port: 11211
    volume_mappings:
    - "/:/buddy/wp-starter-plugin"
    trigger_condition: "ALWAYS"
    shell: "BASH"
    variables:
    - key: "WP_VERSION"
      value: "trunk"
  - action: "npm ci"
    type: "BUILD"
    working_directory: "/buddy/wp-starter-plugin"
    docker_image_name: "library/node"
    docker_image_tag: "12"
    execute_commands:
    - "npm ci --cache .npm"
    volume_mappings:
    - "/:/buddy/wp-starter-plugin"
    trigger_condition: "ALWAYS"
    shell: "BASH"
    run_next_parallel: true
  - action: "npm audit"
    type: "BUILD"
    working_directory: "/buddy/wp-starter-plugin"
    docker_image_name: "library/node"
    docker_image_tag: "12"
    execute_commands:
    - "npm audit --audit-level=high --production"
    volume_mappings:
    - "/:/buddy/wp-starter-plugin"
    trigger_condition: "ALWAYS"
    shell: "BASH"
  - action: "npm build"
    type: "BUILD"
    working_directory: "/buddy/wp-starter-plugin"
    docker_image_name: "library/node"
    docker_image_tag: "12"
    execute_commands:
    - "npm run build"
    volume_mappings:
    - "/:/buddy/wp-starter-plugin"
    trigger_condition: "ALWAYS"
    shell: "BASH"
    run_next_parallel: true
  - action: "phpcs"
    type: "BUILD"
    working_directory: "/buddy/wp-starter-plugin"
    docker_image_name: "alleyops/ci-resources"
    docker_image_tag: "7.3-fpm-wp"
    execute_commands:
    - "composer -q global require alleyinteractive/alley-coding-standards"
    - ""
    - "phpcs -n"
    volume_mappings:
    - "/:/buddy/wp-starter-plugin"
    trigger_condition: "ALWAYS"
    shell: "BASH"
  variables:
  - key: "COMPOSER_BIN_DIR"
    value: "/usr/local/bin"
  - key: "PLUGIN_SLUG"
    value: "wp-starter-plugin"
  - key: "WP_COMPOSER_HOME"
    value: "/buddy/wp-starter-plugin/.composer"
  - key: "WP_CORE_DIR"
    value: "/tmp/wordpress"
  - key: "WP_TESTS_DIR"
    value: "/tmp/wordpress-tests-lib"
